{% extends "layout.html" %}
{% set active_page = "home" %}

{% import "components/community/login.html" as login %}
{% import 'components/config/evaluator_card.html' as m_config_evaluator_card %}
{% import "components/config/profiles.html" as profiles_macros %}
{% import 'macros/flash_messages.html' as m_flash_messages %}

{% macro profile_overview(profile, current_profile) -%}
<div class="col col-md-4 px-1 profile-overview {{'profile-overview-selected' if profile.profile_id == current_profile.profile_id}}">
    <div class="p-2 vertically-aligned">
        <h4>
            {{ profile.name | safe }}
            {% if profile.profile_id == current_profile.profile_id %}
            <span class="badge badge-danger float-right mr-2">active</span>
            {% endif %}
        </h4>
        <div class="text-center">
            <img src="{{url_for('profile_media', path=profile.avatar_path) if profile.avatar_path else url_for('static', filename='img/default_profile.png')}}"
                 class="img-fluid profile-overview-image" alt="{{profile.name}}">
        </div>
        <p class="pt-2 text-center">
            {{ profile.description | safe }}
        </p>
        <div class="d-flex justify-content-between px-2 px-md-4">
            <div>
                <button class="btn btn-outline-primary btn-md"
                        data-toggle="modal" data-target="#{{profile.profile_id}}Modal">
                    <i class="fa fa-search" no-activation-click="true"></i>
                </button>
                {{ profile_details_modal(profile) }}
            </div>
            <div>
                {% if profile.profile_id != current_profile.profile_id %}
                <button class="btn btn-primary btn-md activate-profile-button"
                        data-toggle="tooltip" data-placement="top"
                        title="Use this profile"
                        data-url="{{url_for('profile', select=profile.profile_id, next=url_for('onboarding'))}}">
                    <i class="fa fa-check" no-activation-click="true"></i>
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}

{% macro profile_details_modal(profile) %}
    <div class="modal fade" id="{{profile.profile_id}}Modal" tabindex="-1" role="dialog" aria-labelledby="#{{profile.profile_id}}ModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content modal-text bg-dark text-light mt-4">
          <div class="modal-header primary-text">
              <h5 class="modal-title" id="{{profile.profile_id}}ModalLabel">
                  {{profile.name}}
              </h5>
            <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            {{ profiles_macros.profile_details(profile, profiles_tentacles_details[profile.profile_id], strategy_config,
              evaluator_config, get_profile_traded_pairs_by_currency, get_profile_exchanges,
              get_enabled_trader, get_filtered_list, True) }}
          </div>
        </div>
      </div>
    </div>
{% endmacro %}

{% block body %}
<br>
<div class="card">
    <div class="card-header">
        <h2>Welcome to OctoBot</h2>
    </div>
    <div class="card-body px-3">
        {% if current_logged_in_email %}
        <div class="alert alert-dark row py-0">
            <div class="col-8 my-auto">
                Logged in as {{current_logged_in_email}}
                {% if selected_user_bot["name"] %}
                    using bot <span class="badge badge-info">{{ selected_user_bot["name"] }}</span>
                {% else %}
                    <span class="badge badge-danger">without selected bot</span>
                {% endif %}
            </div>
            {% if can_logout %}
            <div class="col-4 text-right">
                <a class="align-right btn btn-sm btn-outline-info waves-effect"
                   href="{{ url_for('community_logout', next=url_for('onboarding'))}}">
                    logout
                </a>
            </div>
            {% endif %}
        </div>
        {{ m_flash_messages.flash_messages() }}
        {% else %}
        <div>
            Login to you OctoBot Account to access your subscribed profiles as well as the additional profiles.

            <div class="login_box mx-auto mt-1 mt-xl-5">
                {{ login.login_form(form, is_in_stating_community_env, url_for("onboarding"), "sync_account") }}
            </div>
        </div>
        {% endif %}
        <h3>
            Select the profile your OctoBot use

            <div class="float-right">
                <button class="btn btn-outline-primary waves-effect"
                        data-toggle="modal" data-target="#importProfileModal">
                    Import a profile
                </button>
            </div>
        </h3>
        <p>
            A profile is a ready-made configuration of OctoBot. You can change it at any time.
            You will be able to create and customize your from the <span class="font-weight-bold">Profile</span> tab.
        </p>
        <div class="row mx-0">
            {% for profile in profiles %}
            {{ profile_overview(profile, current_profile) }}
            {% endfor %}
        </div>
    </div>
</div>

<br>

<!-- Modals -->
{{ profiles_macros.profile_import_modal(url_for('onboarding')) }}
{% for trading_mode_name, info in strategy_config["trading-modes"].items() %}
    {{ m_config_evaluator_card.evaluator_card_modal(trading_mode_name, info, False, True) }}
{% endfor %}
{% for evaluator_name, info in strategy_config["strategies"].items() %}
    {{ m_config_evaluator_card.evaluator_card_modal(evaluator_name, info, True, True) }}
{% endfor %}
{% for evaluator_type_items in ['ta', 'social', 'real-time'] %}
    {% for evaluator_name, info in evaluator_config[evaluator_type_items].items() %}
        {{ m_config_evaluator_card.evaluator_card_modal(evaluator_name, info, True, True) }}
    {% endfor %}
{% endfor %}
{% endblock %}

{% block additional_scripts %}
<script src="{{ url_for('static', filename='js/common/resources_rendering.js', u=LAST_UPDATED_STATIC_FILES) }}"></script>
<script src="{{ url_for('static', filename='js/components/profile_management.js', u=LAST_UPDATED_STATIC_FILES) }}"></script>
<script src="{{ url_for('static', filename='js/components/onboarding.js', u=LAST_UPDATED_STATIC_FILES) }}"></script>
{% endblock additional_scripts %}