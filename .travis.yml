notifications:
  email: false
dist: xenial
os: linux
language: python
python: 3.7-dev
cache: pip
env:
  global:
    - GH_REPO=Drakkar-Software/OctoBot-Tentacles
    - OCTOBOT_GH_REPO=https://github.com/Drakkar-Software/OctoBot.git
    - DEPLOY_BRANCH=0.4.0
    - PACKAGE_FOLDER=octobot
    - OCTOBOT_DEFAULT_BRANCH=0.4.0
    - LATEST_TAG=latest
    - DEPLOY_URL=https://www.tentacles.octobot.online/repository/tentacles/officials/base
    - DEV_DEPLOY_URL=$DEPLOY_URL/dev
    - TRAVIS_CLEANED_BRANCH=${TRAVIS_BRANCH////_}

install:
  - git clone -q $OCTOBOT_GH_REPO -b $TRAVIS_BRANCH || git clone -q $OCTOBOT_GH_REPO -b $OCTOBOT_DEFAULT_BRANCH
  - cd OctoBot
  - python3 -m pip install --prefer-binary -r dev_requirements.txt -r requirements.txt
  - cd ..
  - mkdir new_tentacles
  - cp -r Backtesting Evaluator Services Trading new_tentacles
  - cd OctoBot
  - python3 start.py tentacles -d "../new_tentacles" -p "../new_tentacles.zip"
  - python3 start.py tentacles --install --location "../new_tentacles.zip" --all

jobs:
  include:
    - name: "Linux - Python 3.7-dev - Python sources"
      stage: test
      os: linux
      python: 3.7-dev
      language: python
      script:
        - pytest --cov=. --cov-config=../.coveragerc --durations=0 tentacles
      after_success:
        - if [ $TRAVIS_PULL_REQUEST == "false" ]; then coveralls; fi

    - name: "Linux - Python 3.7-dev - Installed"
      stage: test
      os: linux
      python: 3.7-dev
      language: python
      env: CYTHON_TEST_IGNORE=true
      script:
        - python3 setup.py build_ext --inplace
        - python3 setup.py install
        - rm -rf $PACKAGE_FOLDER
        - pytest --durations=0 tentacles

    - name: "Linux - Tentacles - Deploy"
      stage: deploy
      os: linux
      script: skip
      deploy:
        - provider: script
          script: curl -v --user "$NEXUS_USERNAME:$NEXUS_PASSWORD" --upload-file ../new_tentacles.zip  $DEPLOY_URL/$TRAVIS_TAG.zip
          skip_cleanup: true
          cleanup: false
          on:
            repo: "$GH_REPO"
            tags: true
            branch: "$DEPLOY_BRANCH"
        - provider: script
          script: curl -v --user "$NEXUS_USERNAME:$NEXUS_PASSWORD" --upload-file ../new_tentacles.zip  $DEPLOY_URL/$LATEST_TAG.zip
          skip_cleanup: true
          cleanup: false
          on:
            repo: "$GH_REPO"
            tags: false
            branch: "$DEPLOY_BRANCH"
        - provider: script
          script: curl -v --user "$NEXUS_USERNAME:$NEXUS_PASSWORD" --upload-file ../new_tentacles.zip $DEV_DEPLOY_URL/$TRAVIS_CLEANED_BRANCH.zip
          skip_cleanup: true
          cleanup: false
          on:
            repo: "$GH_REPO"
            tags: false
            all_branches: true

after_failure:
  - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
  - chmod +x send.sh
  - ./send.sh failure https://discordapp.com/api/webhooks/$WEBHOOK_TOKEN
