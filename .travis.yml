notifications:
  email: false
dist: xenial
os: linux
language: python
python: 3.7-dev
cache: pip
env:
  global:
    - GH_REPO=Drakkar-Software/OctoBot-Tentacles
    - DEPLOY_BRANCH=0.4.0
    - OCTOBOT_BRANCH=0.4.0
    - LATEST_TAG=latest
    - DEPLOY_URL=https://www.tentacles.octobot.online/repository/tentacles/officials/base

install:
  - git clone https://github.com/Drakkar-Software/OctoBot.git -b $OCTOBOT_BRANCH && cd OctoBot
  - python3 -m pip install --prefer-binary -r dev_requirements.txt -r requirements.txt
  - cd ..

matrix:
  include:
    - name: "Linux - Python 3.7 - Python sources"
      stage: test
      os: linux
      python: 3.7-dev
      language: python
      script:
        - mkdir new_tentacles
        - cp -r Backtesting Evaluator Interfaces Notifiers Services Trading new_tentacles
        - cd OctoBot
        - python3 start.py tentacles -d "../new_tentacles" -p "../new_tentacles.zip"
        - python3 start.py tentacles --install --location "../new_tentacles.zip" --all
        - pytest --cov=. --cov-config=.coveragerc --durations=0 tentacles
      after_success:
        - if [ $TRAVIS_PULL_REQUEST == "false" ]; then coveralls; fi

    - name: "Linux - Tentacles - Deploy"
      stage: deploy
      os: linux
      install: skip
      deploy:
        - provider: script
          script: mv $LATEST_TAG.zip $TRAVIS_TAG.zip && curl -v --user "$NEXUS_USERNAME:$NEXUS_PASSWORD" --upload-file ./new_tentacles.zip  $DEPLOY_URL/$TRAVIS_TAG.zip
          skip_cleanup: true
          cleanup: false
          on:
            repo: "$GH_REPO"
            tags: true
            branch: "$DEPLOY_BRANCH"
        - provider: script
          script: curl -v --user "$NEXUS_USERNAME:$NEXUS_PASSWORD" --upload-file ./new_tentacles.zip  $DEPLOY_URL/$LATEST_TAG.zip
          skip_cleanup: true
          cleanup: false
          on:
            repo: "$GH_REPO"
            tags: false
            branch: "$DEPLOY_BRANCH"
